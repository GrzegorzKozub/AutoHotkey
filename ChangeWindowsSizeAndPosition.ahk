; Settings

Setup( { Options: [ { Left: 150, Top: 50, Stretch: True, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Max: True, Screens: [ { P: 1440, Dpi: 192 }
                                                                            , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Microsoft SQL Server Management Studio"
                  , "Microsoft Visual Studio"
                  , "Visual Studio Code" ] } )

Setup( { Options: [ { Left: 300, Top: 100, Stretch: True, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Max: True, Screens: [ { P: 1440, Dpi: 192 }
                                                                            , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "BareTail"
                  , "Inkscape"
                  , "JetBrains dotPeek"
                  , "paint.net"
                  , "Remote Desktop Connection"
                  , "SourceTree" ] } )

Setup( { Options: [ { Left: 450, Top: 150, Stretch: True, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Width: 2560, Height: 1360, Center: True, Max: True, Screens: [ { P: 1440, Dpi: 192 } ] }
                  , { Width: 3200, Height: 1700, Center: True, Max: True, Screens: [ { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Blizzard App"
                  , "GOG Galaxy"
                  , "Origin"
                  , "Steam"
                  , "Uplay" ] } )

Setup( { Options: [ { Left: 600, Top: 200, Stretch: True, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Left: 250, Top: 50, Stretch: True, Screens: [ { P: 1440, Dpi: 192 }
                                                                  , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Fiddler Web Debugger"
                  , "LOOT"
                  , "Mod Organizer" ] } )

Setup( { Options: [ { Left: 600, Top: 200, Stretch: True, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { P: 1440, Dpi: 192 }
                                                                  , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Defender"
                  , "Event Viewer"
                  , "Hyper-V Manager"
                  , "Internet Information Services (IIS) Manager"
                  , "NVIDIA Control Panel"
                  , "Registry Editor"
                  , "Task Scheduler"
                  , "Settings" ] } )

Setup( { Options: [ { Left: 750, Top: 250, Stretch: True, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Left: 650, Top: 150, Stretch: True, Screens: [ { P: 1440, Dpi: 192 }
                                                                   , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ { Class: "FM" } ; 7-Zip
                  , "Deluge"
                  , "Find Files" ; Total Commander
                  , "KeePass"
                  , "Lister" ; Total Commander
                  , "Multi-Rename Tool" ; Total Commander
                  , "Notepad"
                  , "OBS"
                  , "Oracle VM VirtualBox Manager"
                  , "Rapid Environment Editor"
                  , "Resource Hacker"
                  , "Synchronize directories" ] } ) ; Total Commander

Setup( { Options: [ { Width: 1600, Left: 25, Top: 25, Bottom: 25, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Max: True, Screens: [ { P: 1440, Dpi: 192 }
                                                                            , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Developer Tools" ; Chrome and Edge
                  , "Edge"
                  , "Google Chrome"
                  , "Pluralsight" ] } )

Setup( { Options: [ { Width: 1611, Height: 1005, Left: 75, Bottom: 75, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Width: 2462, Height: 1289, Center: True, Max: True, Screens: [ { P: 1440, Dpi: 192 } ] }
                  , { Width: 3074, Height: 1567, Center: True, Max: True, Screens: [ { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "GVIM" ] } )

Setup( { Options: [ { Width: 1100, Right: 25, Top: 25, Bottom: 25, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { P: 1440, Dpi: 192 }
                                                                  , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "SumatraPDF" ] } )

Setup( { Options: [ { Width: 1300, Height: 900, Right: 75, Top: 75, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { P: 1440, Dpi: 192 }
                                                                  , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Total Commander" ] } )

Setup( { Options: [ { Width: 1613, Height: 962, Right: 25, Bottom: 25, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Width: 2080, Height: 1141, Right: 50, Bottom: 50, Screens: [ { P: 1440, Dpi: 192 } ] }
                  , { Width: 2595, Height: 1408, Right: 50, Bottom: 50, Screens: [ { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ { Class: "VirtualConsoleClass" } ] } ) ; ConEmu

Setup( { Options: [ { Width: 700, Height: 600, Right: 25, Bottom: 25, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Width: 1350, Height: 1150, Right: 50, Bottom: 50, Screens: [ { P: 1440, Dpi: 192 } ] }
                  , { Width: 1700, Height: 1400, Right: 50, Bottom: 50, Screens: [ { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Task Manager" ] } )

Setup( { Options: [ { Width: 320, Height: 500, Right: 25, Bottom: 25, Screens: [ { P: 1440, Dpi: 96 } ] }
                  , { Width: 660, Height: 1000, Right: 50, Bottom: 50, Screens: [ { P: 1440, Dpi: 192 }
                                                                                , { P: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Friends" ] } ) ; Blizzard App, GOG Galaxy, Steam

; Main

#SingleInstance force

SplitPath A_ScriptName,,,, fileName
Menu Tray, Icon, %fileName%.ico
SetTitleMatchMode 2
HotKey ^#w, FixActiveWindow
HotKey ^#c, CenterActiveWindow
InitShellHooks()
return

; Shell hooks

InitShellHooks() {
    Gui +LastFound +HwndWindowHwnd
    DllCall("RegisterShellHookWindow", UInt, WindowHwnd)
    msgNumber := DllCall("RegisterWindowMessage", Str, "SHELLHOOK")
    OnMessage(msgNumber, "HandleMessage")
}

HandleMessage(wParam, lParam) {
    if (wParam != 1) { ; HSHELL_WINDOWCREATED
        return
    }
    try {
        global _settings
        monitor := GetPrimaryMonitor()
        Sleep 1000
        window := GetActiveWindow()
        Fix(_settings, monitor, window)
    } catch { }
}

; Labels

FixActiveWindow:
    try {
        global _settings
        monitor := GetPrimaryMonitor()
        window := GetActiveWindow()
        Fix(_settings, monitor, window)
    } catch e {
        MsgBox 48,, %e%
    }
    return

CenterActiveWindow:
    try {
        monitor := GetPrimaryMonitor()
        window := GetActiveWindow()
        Center(monitor, window)
    } catch e {
        MsgBox 48,, %e%
    }
    return

; Functions

Setup(settingsChunk) {
    global _settings
    if (!_settings) {
        _settings := Object()
    }
    _settings.Insert(settingsChunk)
}

GetPrimaryMonitor() {
    SysGet monitor, Monitor, %current%
    SysGet monitorWorkArea, MonitorWorkArea, %current%
    return { P: monitorBottom
        , Dpi: GetPrimaryMonitorDpi()
        , Width: monitorWorkAreaRight - monitorWorkAreaLeft
        , Height: monitorWorkAreaBottom - monitorWorkAreaTop }
}

GetPrimaryMonitorDpi() {
    ; Returns 96 (for 100%), 120, 144, 168, 192 (for 200%), 216, 240 (for 250%)...
    RegRead dpi, HKEY_CURRENT_USER, Control Panel\Desktop\WindowMetrics, AppliedDPI
    return (ErrorLevel = 1) ? 96 : dpi
}

GetActiveWindow() {
    WinGetTitle title, A
    WinGetClass class, A
    return { Title: title, Class: class }
}

Fix(settings, monitor, window) {
    options := FindMatch(settings, monitor, window)
    window := MeasureWindow(window)
    RestoreWindow(window)
    MoveWindow(monitor, options, window)
    if (options.Center) {
        window := MeasureWindow(window)
        CenterWindow(monitor, window)
    }
    if (options.Max) {
        MaximizeWindow(window)
    }
}

Center(monitor, window) {
    window := MeasureWindow(window)
    RestoreWindow(window)
    window := MeasureWindow(window)
    CenterWindow(monitor, window)
}

FindMatch(settings, monitor, window) {
    for key, group in settings {
        for key, windowInConfig in group.Windows {
            if (WindowMatchesConfig(window, windowInConfig)) {
                for key, options in group.Options {
                    for key, monitorInConfig in options.Screens {
                        if (MonitorMatchesConfig(monitor, monitorInConfig)) {
                            return options
                        }
                    }
                }
            }
        }
    }
    throw "Match not found"
}

WindowMatchesConfig(windowOnScreen, windowInConfig) {
    if (windowInConfig.Class && windowInConfig.Title) {
        return windowOnScreen.Class == windowInConfig.Class && InStr(windowOnScreen.Title, windowInConfig.Title) > 0
    } else if (windowInConfig.Class) {
        return windowOnScreen.Class == windowInConfig.Class
    } else {
        return InStr(windowOnScreen.Title, windowInConfig.Title ? windowInConfig.Title : windowInConfig) > 0
    }
}

MonitorMatchesConfig(actualMonitor, monitorInConfig) {
    return actualMonitor.P == monitorInConfig.P && actualMonitor.Dpi == monitorInConfig.Dpi
}

MeasureWindow(window) {
    class := window.Class
    WinGetPos x, y, width, height, ahk_class %class%
    window.Left := x
    window.Top := y
    window.Width := width
    window.Height := height
    return window
}

RestoreWindow(window) {
    class := window.Class
    WinRestore ahk_class %class%
}

MaximizeWindow(window) {
    class := window.Class
    WinMaximize ahk_class %class%
}

CenterWindow(monitor, window) {
    class := window.Class
    WinMove ahk_class %class%,, (monitor.Width / 2) - (window.Width / 2), (monitor.Height / 2) - (window.Height / 2)
}

MoveWindow(monitor, options, window) {
    if (!options.Left) {
        options.Left := -options.Right
    }
    if (!options.Top) {
        options.Top := -options.Bottom
    }
    options.Width := GetSize(options.Width, window.Width, monitor.Width, options.Left, options.Right, options.Stretch)
    options.Height := GetSize(options.Height, window.Height, monitor.Height, options.Top, options.Bottom, options.Stretch)
    options.Left := GetMargin(options.Left, window.Left, options.Width, monitor.Width)
    options.Top := GetMargin(options.Top, window.Top, options.Height, monitor.Height)
    class := window.Class
    WinMove ahk_class %class%,, options.Left, options.Top, options.Width, options.Height
}

GetSize(size, windowSize, monitorSize, startMargin, endMargin, stretch) {
    if (size) {
        return size
    }
    if (stretch) {
        return monitorSize - (2 * startMargin)
    } else if (endMargin) {
        return monitorSize - startMargin - endMargin
    } else {
        return windowSize
    }
}

GetMargin(margin, windowMargin, size, monitorSize) {
    if (!margin) {
        return windowMargin
    } else if (margin < 0) {
        return monitorSize - (size + Abs(margin))
    } else {
        return margin
    }
}

