; Settings

Setup( { Options: [ { Left: 150, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                                 , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Microsoft SQL Server Management Studio"
                  , "Microsoft Visual Studio"
                  , "Visual Studio Code" ] } )

Setup( { Options: [ { Left: 300, Top: 100, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                                 , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "BareTail"
                  , "Inkscape"
                  , "JetBrains dotPeek"
                  , "paint.net"
                  , "Remote Desktop Connection"
                  , "SourceTree" ] } )

Setup( { Options: [ { Left: 450, Top: 150, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 2560, Height: 1360, Center: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 3200, Height: 1700, Center: True, Maximize: True, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Blizzard App"
                  , "GOG Galaxy"
                  , "Origin"
                  , "Steam"
                  , "Uplay" ] } )

Setup( { Options: [ { Left: 600, Top: 200, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 250, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                  , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Fiddler Web Debugger"
                  , "LOOT"
                  , "Mod Organizer" ] } )

Setup( { Options: [ { Left: 600, Top: 200, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                  , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Defender"
                  , "Event Viewer"
                  , "Hyper-V Manager"
                  , "Internet Information Services (IIS) Manager"
                  , "NVIDIA Control Panel"
                  , "Registry Editor"
                  , "Task Scheduler"
                  , "Settings" ] } )

Setup( { Options: [ { Left: 750, Top: 250, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 650, Top: 150, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                   , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "C:\Users\Grzegorz\" ; 7-Zip
                  , "Deluge"
                  , "Find Files" ; Total Commander
                  , "KeePass"
                  , "Lister" ; Total Commander
                  , "Multi-Rename Tool" ; Total Commander
                  , "Notepad"
                  , "OBS"
                  , "Oracle VM VirtualBox Manager"
                  , "Rapid Environment Editor"
                  , "Resource Hacker"
                  , "Synchronize directories" ] } ) ; Total Commander

Setup( { Options: [ { Width: 1600, Left: 25, Top: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                                 , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Developer Tools" ; Chrome and Edge
                  , "Edge"
                  , "Google Chrome"
                  , "Pluralsight" ] } )

Setup( { Options: [ { Width: 1611, Height: 1005, Left: 75, Bottom: 75, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 2462, Height: 1289, Center: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 3074, Height: 1567, Center: True, Maximize: True, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "GVIM" ] } )

Setup( { Options: [ { Width: 1100, Right: 25, Top: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                  , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "SumatraPDF" ] } )

Setup( { Options: [ { Width: 1300, Height: 900, Right: 75, Top: 75, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                  , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Total Commander" ] } )

Setup( { Options: [ { Width: 1613, Height: 962, Right: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 2080, Height: 1141, Right: 50, Bottom: 50, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 2595, Height: 1408, Right: 50, Bottom: 50, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "~" ] } ) ; ConEmu

Setup( { Options: [ { Width: 700, Height: 600, Right: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 1350, Height: 1150, Right: 50, Bottom: 50, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 1700, Height: 1400, Right: 50, Bottom: 50, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Task Manager" ] } )

Setup( { Options: [ { Width: 320, Height: 500, Right: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 660, Height: 1000, Right: 50, Bottom: 50, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                                , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Friends" ] } ) ; Blizzard App, GOG Galaxy, Steam

; Main

SplitPath A_ScriptName,,,, fileName
Menu Tray, Icon, %fileName%.ico
SetTitleMatchMode 2
HotKey ^#w, FixActiveWindow
HotKey ^#c, CenterActiveWindow
return

; Labels

FixActiveWindow:
    _screens := GetScreens()
    WinGetActiveTitle activeWindowTitle
    FixWindow(activeWindowTitle)
    return

CenterActiveWindow:
    _screens := GetScreens()
    WinGetActiveTitle activeWindowTitle
    CenterWindow(activeWindowTitle)
    return

; Functions

Setup(options) {
    global _settings
    if (!_settings) {
        _settings := Object()
    }
    _settings.Insert(options)
}

GetScreens() {
    SysGet count, 80
    screens := Object()
    i := 1
    while i <= count {
        SysGet monitor, Monitor, %current%
        SysGet monitorWorkArea, MonitorWorkArea, %current%
        screens[i] := { Number: i
            , Resolution: monitorBottom
            , Dpi: GetDpi()
            , Width: monitorWorkAreaRight - monitorWorkAreaLeft
            , Height: monitorWorkAreaBottom - monitorWorkAreaTop }
        i++
    }
    return screens
}

ResolveScreen(preferred) {
    global _screens
    if (_screens[preferred]) {
        return _screens[preferred]
    } else {
        return _screens[1]
    }
}

GetDpi() {
    ; Returns 96 (for 100%), 120, 144, 168, 192 (for 200%), 216, 240 (for 250%)...
    RegRead dpi, HKEY_CURRENT_USER, Control Panel\Desktop\WindowMetrics, AppliedDPI
    return (ErrorLevel = 1) ? 96 : dpi
}

FixWindow(title) {
    match := FindMatch(title)
    if (!match) {
        return
    }
    window := GetWindow(title)
    if (!window) {
        return
    }
    RestoreWindow(title)
    MoveWindowToScreen(window, match.Screen, match.Options)
    if (match.Options.Center) {
        window := GetWindow(title)
        CenterWindowOnScreen(window, match.Screen)
    }
    if (match.Options.Maximize) {
        MaximizeWindow(title)
    }
}

CenterWindow(title) {
    window := GetWindow(title)
    if (!window) {
        return
    }
    RestoreWindow(title)
    window := GetWindow(title)
    screen := ResolveScreen(1)
    CenterWindowOnScreen(window, screen)
}

FindMatch(title) {
    global _settings
    for key, group in _settings {
        for key, window in group.Windows {
            find := window.Find ? window.Find : window
            except := window.Except ? window.Except : ""
            resolvedScreen := ResolveScreen(window.Screen)
            if (InStr(title, find) > 0 && (!except || InStr(title, except) == 0)) {
                for key, options in group.Options {
                    for key, configuredScreen in options.Screens {
                        if (configuredScreen.Resolution == resolvedScreen.Resolution && configuredScreen.Dpi == resolvedScreen.Dpi) {
                            return { Screen: resolvedScreen, Options: options }
                        }
                    }
                }
            }
        }
    }
    MsgBox 48,, Match not found
}

GetWindow(title) {
    WinGetPos x, y, width, height, %title%
    if (!x) {
        return
    }
    WinGet minMax, MinMax, %title%
    return { Title: title, Left: x, Top: y, Width: width, Height: height }
}

MoveWindowToScreen(window, screen, options) {
    if (!options.Left) {
        options.Left := -options.Right
    }
    if (!options.Top) {
        options.Top := -options.Bottom
    }
    options.Width := GetSize(options.Width, window.Width, screen.Width, options.Left, options.Right, options.Stretch)
    options.Height := GetSize(options.Height, window.Height, screen.Height, options.Top, options.Bottom, options.Stretch)
    options.Left := GetMargin(options.Left, window.Left, options.Width, screen.Width)
    options.Top := GetMargin(options.Top, window.Top, options.Height, screen.Height)
    WinMove % window.Title,, options.Left, options.Top, options.Width, options.Height
}

GetSize(size, windowSize, screenSize, startMargin, endMargin, stretch) {
    if (size) {
        return size
    }
    if (stretch) {
        return screenSize - (2 * startMargin)
    } else if (endMargin) {
        return screenSize - startMargin - endMargin
    } else {
        return windowSize
    }
}

GetMargin(margin, windowMargin, size, screenSize) {
    if (!margin) {
        return windowMargin
    } else if (margin < 0) {
        return screenSize - (size + Abs(margin))
    } else {
        return margin
    }
}

CenterWindowOnScreen(window, screen) {
    WinMove % window.Title,, (screen.Width / 2) - (window.Width / 2), (screen.Height / 2) - (window.Height / 2)
}

RestoreWindow(title) {
    WinRestore % title
}

MaximizeWindow(title) {
    WinMaximize % title
}

