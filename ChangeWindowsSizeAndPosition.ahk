; Settings

Setup( { Options: [ { Left: 150, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                                 , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Microsoft SQL Server Management Studio"
                  , "Microsoft Visual Studio"
                  , "Visual Studio Code" ] } )

Setup( { Options: [ { Left: 300, Top: 100, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                                 , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "BareTail"
                  , "Inkscape"
                  , "JetBrains dotPeek"
                  , "paint.net"
                  , "Remote Desktop Connection"
                  , "SourceTree"
                  , "WinSnap" ] } )

Setup( { Options: [ { Left: 450, Top: 150, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 2560, Height: 1360, Center: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 3200, Height: 1700, Center: True, Maximize: True, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Blizzard App"
                  , "GOG Galaxy"
                  , "Origin"
                  , "Steam" ] } )

Setup( { Options: [ { Left: 600, Top: 200, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 250, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                  , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Fiddler Web Debugger"
                  , "LOOT"
                  , "Mod Organizer"
                  , "Pogoda" ] } )

Setup( { Options: [ { Left: 600, Top: 200, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                  , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Defender"
                  , "Event Viewer"
                  , "Hyper-V Manager"
                  , "Internet Information Services (IIS) Manager"
                  , "NVIDIA Control Panel"
                  , "Registry Editor"
                  , "Task Scheduler"
                  , "Settings" ] } )

Setup( { Options: [ { Left: 750, Top: 250, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 650, Top: 150, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                   , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "C:\Users\Grzegorz\" ; 7-Zip
                  , "Deluge"
                  , "KeePass"
                  , "Lister" ; Total Commander
                  , "Notepad"
                  , "OBS"
                  , "Oracle VM VirtualBox Manager"
                  , "Rapid Environment Editor"
                  , "Resource Hacker" ] } )

Setup( { Options: [ { Width: 1296, Height: 832, Center: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 1306, Height: 882, Center: True, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 1312, Height: 910, Center: True, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "VLC media player" ] } )

Setup( { Options: [ { Width: 900, Height: 600, Center: True, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 1660, Height: 1000, Center: True, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 2100, Height: 1400, Center: True, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "SyncBackPro" ] } )

Setup( { Options: [ { Width: 1600, Left: 25, Top: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 50, Top: 50, Stretch: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                                 , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Developer Tools" ; Chrome and Edge
                  , "Edge"
                  , "Google Chrome"
                  , "Pluralsight" ] } )

Setup( { Options: [ { Width: 1611, Height: 1005, Left: 75, Bottom: 75, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 2462, Height: 1289, Center: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 3074, Height: 1567, Center: True, Maximize: True, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "GVIM" ] } )

Setup( { Options: [ { Width: 1100, Right: 25, Top: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                  , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "SumatraPDF" ] } )

Setup( { Options: [ { Width: 1300, Height: 900, Right: 75, Top: 75, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Left: 450, Top: 50, Stretch: True, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                  , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Total Commander" ] } )

Setup( { Options: [ { Width: 1613, Height: 962, Right: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 2080, Height: 1280, Center: True, Maximize: True, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 2695, Height: 1587, Center: True, Maximize: True, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "~" ] } ) ; ConEmu

Setup( { Options: [ { Width: 700, Height: 600, Right: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 1350, Height: 1150, Right: 50, Bottom: 50, Screens: [ { Resolution: 1440, Dpi: 192 } ] }
                  , { Width: 1700, Height: 1400, Right: 50, Bottom: 50, Screens: [ { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Task Manager" ] } )

Setup( { Options: [ { Width: 320, Height: 500, Right: 25, Bottom: 25, Screens: [ { Resolution: 1440, Dpi: 96 } ] }
                  , { Width: 660, Height: 1000, Right: 50, Bottom: 50, Screens: [ { Resolution: 1440, Dpi: 192 }
                                                                                , { Resolution: 1800, Dpi: 240 } ] } ]
       , Windows: [ "Friends" ] } ) ; Blizzard App, GOG Galaxy, Steam

; Main

SplitPath A_ScriptName,,,, fileName
Menu Tray, Icon, %fileName%.ico
SetTitleMatchMode 2
HotKey ^#w, FixActiveWindow
HotKey ^#c, CenterActiveWindow
return

; Labels

FixActiveWindow:
    _screen := GetScreen()
    WinGetActiveTitle activeWindowTitle
    FixWindow(activeWindowTitle)
    return

CenterActiveWindow:
    _screen := GetScreen()
    WinGetActiveTitle activeWindowTitle
    CenterWindow(activeWindowTitle)
    return

; Functions

Setup(options) {
    global _settings
    if (!_settings) {
        _settings := Object()
    }
    _settings.Insert(options)
}

GetScreen() {
    SysGet monitorNumber, MonitorPrimary
    SysGet monitor, Monitor, %monitorNumber%
    SysGet monitorWorkArea, MonitorWorkArea, %monitorNumber%
    return { Resolution: monitorBottom
        , Dpi: GetDpi()
        , Width: monitorWorkAreaRight - monitorWorkAreaLeft
        , Height: monitorWorkAreaBottom - monitorWorkAreaTop }
}

GetDpi() {
    ; Returns 96 (for 100%), 120, 144, 168, 192 (for 200%), 216, 240 (for 250%)...
    RegRead dpi, HKEY_CURRENT_USER, Control Panel\Desktop\WindowMetrics, AppliedDPI
    return (ErrorLevel = 1) ? 96 : dpi
}

FixWindow(title) {
    options := GetOptions(title)
    if (!options) {
        return
    }
    window := GetWindow(title)
    if (!window) {
        return
    }
    WinRestore %title%
    MoveWindow(window, title, options)
    if (options.Center) {
        CenterWindow(title)
    }
    if (options.Maximize) {
        WinMaximize %title%
    }
}

GetOptions(title) {
    global _settings
    global _screen
    for key, group in _settings {
        for key, window in group.Windows {
            find := window.Find ? window.Find : window
            except := window.Except ? window.Except : ""
            if (InStr(title, find) > 0 && (!except || InStr(title, except) == 0)) {
                for key, options in group.Options {
                    for key, screen in options.Screens {
                        if (screen.Resolution == _screen.Resolution && screen.Dpi == _screen.Dpi) {
                            return options
                        }
                    }
                }
            }
        }
    }
    MsgBox 48,, Window or screen not configured
}

MoveWindow(window, title, options) {
    global _screen
    if (!options.Left) {
        options.Left := -options.Right
    }
    if (!options.Top) {
        options.Top := -options.Bottom
    }
    options.Width := GetSize(options.Width, window.Width, _screen.Width, options.Left, options.Right, options.stretch)
    options.Height := GetSize(options.Height, window.Height, _screen.Height, options.Top, options.Bottom, options.stretch)
    options.Left := GetMargin(options.Left, window.Left, options.Width, _screen.Width)
    options.Top := GetMargin(options.Top, window.Top, options.Height, _screen.Height)
    WinMove % title,, options.Left, options.Top, options.Width, options.Height
}

GetSize(size, windowSize, screenSize, startMargin, endMargin, stretch) {
    if (size) {
        return size
    }
    if (stretch) {
        return screenSize - (2 * startMargin)
    } else if (endMargin) {
        return screenSize - startMargin - endMargin
    } else {
        return windowSize
    }
}

GetMargin(margin, windowMargin, size, screenSize) {
    if (!margin) {
        return windowMargin
    } else if (margin < 0) {
        return screenSize - (size + Abs(margin))
    } else {
        return margin
    }
}

CenterWindow(title) {
    global _screen
    window := GetWindow(title)
    if (!window) {
        return
    }
    WinMove %title%,, (_screen.Width / 2) - (window.Width / 2), (_screen.Height / 2) - (window.Height / 2)
}

GetWindow(title) {
    WinGetPos x, y, width, height, %title%
    if (!x) {
        return
    }
    WinGet minMax, MinMax, %title%
    return { Left: x, Top: y, Width: width, Height: height }
}

